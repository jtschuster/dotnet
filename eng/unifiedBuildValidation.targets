<Project>

  <PropertyGroup>
    <UnifiedBuildValidationTestsDir>$([MSBuild]::NormalizeDirectory('$(RepoRoot)', 'test', 'Microsoft.DotNet.UnifiedBuild.Tests'))</UnifiedBuildValidationTestsDir>
    <UnifiedBuildValidationTestsProject>$([MSBuild]::NormalizePath('$(UnifiedBuildValidationTestsDir)', 'Microsoft.DotNet.UnifiedBuild.Tests.csproj'))</UnifiedBuildValidationTestsProject>
  </PropertyGroup>

  <Target Name="RunUnifiedBuildValidation"
          AfterTargets="Build"
          DependsOnTargets="DetermineSourceBuiltSdkVersion">

    <ItemGroup>
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_SDK_TARBALL_PATH" Value="$(SdkTarballPath)" />
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_TARGET_RID" Value="$(TargetRid)" />
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_PORTABLE_RID" Value="$(PortableRid)" />
      <_UnifiedBuildValidationEnvVar Include="UNIFIED_BUILD_VALIDATION_BUILD_VERSION" Value="$(SourceBuiltSdkVersion)" />
    </ItemGroup>

    <PropertyGroup>
      <SdkTarballPath>%(SdkTarballItem.Identity)</SdkTarballPath>
      <EnvironmentVariableRunSettings>@(_UnifiedBuildValidationEnvVar->'%(Identity)=%(Value)')</EnvironmentVariableRunSettings>
      <runSettings>RunConfiguration.EnvironmentVariables.UNIFIED_BUILD_VALIDATION_ARGS=$([MSBuild]::Escape($(EnvironmentVariableRunSettings)))</runSettings>
    </PropertyGroup>

    <MSBuild Projects="$(UnifiedBuildValidationTestsProject)"
             Targets="VSTest"
             Properties="VsTestUseMSBuildOutput=true;
                         IsTestProject=true;
                         Configuration=$(Configuration);
                         VSTestLogger=trx;
                         VSTestCLIRunSettings=$(runSettings)" />

  </Target>

</Project>
